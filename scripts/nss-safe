#!/usr/bin/env bash
set -euo pipefail

# =============================
# NSS SAFE ‚Äî TRYB DECYZYJNY
# =============================

ROOT="/etc/nixos"
HOST="$(hostname)"
SESSION_FILE="$ROOT/SESJE/AKTYWNA.md"

# ---------- FLAGS ----------
DRY=0
PANIC=0

for arg in "$@"; do
  case "$arg" in
  --dry) DRY=1 ;;
  --panic) PANIC=1 ;;
  esac
done

# ---------- COLORS ----------
RED="\033[31m"
YELLOW="\033[33m"
GREEN="\033[32m"
RESET="\033[0m"

fail() {
  echo -e "${RED}‚ùå $1${RESET}"
  exit 1
}
warn() { echo -e "${YELLOW}‚ö†Ô∏è  $1${RESET}"; }
ok() { echo -e "${GREEN}‚úÖ $1${RESET}"; }

header() {
  echo
  echo "=============================="
  echo "üõ°  NSS ‚Äî TRYB DECYZYJNY"
  echo "=============================="
  echo
}

# ---------- HEADER ----------
header

cd "$ROOT"

# ---------- PANIC ----------
if [[ "$PANIC" -eq 1 ]]; then
  echo "üßØ PANIC MODE: rollback"
  sudo nixos-rebuild switch --rollback || fail "Rollback failed"
  ok "Rollback OK"
  exit 0
fi

[[ "$DRY" -eq 1 ]] && warn "DRY RUN: brak zmian w systemie"

# ---------- REPO INFO ----------
echo "üì¶ Repo: /etc/nixos"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
git status --short || true
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# ---------- RISK ----------
CRITICAL_PATHS=(
  "nixos/configuration.nix"
  "flake.nix"
  "modules/boot.nix"
  "modules/graphics.nix"
)

RISK="NORMAL"
for path in "${CRITICAL_PATHS[@]}"; do
  if git diff --name-only | grep -q "^$path"; then
    RISK="HIGH"
  fi
done

echo "Ryzyko: $RISK"
echo

# ---------- MENU ----------
echo "Wybierz tryb:"
echo
echo "[A] tylko build"
echo "[B] build + switch"
echo "[C] build + switch + commit + push (wymaga: ga)"
echo "[D] abort (domy≈õlne)"
echo

read -r -p "Wyb√≥r: " CHOICE
CHOICE="${CHOICE:-D}"

case "$CHOICE" in
A | a) MODE="build" ;;
B | b) MODE="switch" ;;
C | c) MODE="commit" ;;
*) fail "Abort by user" ;;
esac

ok "Wybrany tryb: $MODE"

# ---------- BUILD ----------
echo
echo "üèó  BUILD: nix build (system)"
if [[ "$DRY" -eq 1 ]]; then
  warn "DRY: pomijam build"
else
  nix build "$ROOT#nixosConfigurations.$HOST.config.system.build.toplevel" ||
    fail "Build failed"
  ok "Build OK"
fi

# ---------- SWITCH ----------
if [[ "$MODE" == "switch" || "$MODE" == "commit" ]]; then
  echo
  echo "üîÅ SWITCH: nixos-rebuild switch"
  if [[ "$DRY" -eq 1 ]]; then
    warn "DRY: pomijam switch"
  else
    sudo nixos-rebuild switch --flake "$ROOT#$HOST" ||
      fail "Switch failed"
    ok "Switch OK"
  fi
fi

# ---------- COMMIT ----------
if [[ "$MODE" == "commit" && "$DRY" -eq 0 ]]; then
  echo
  echo "üì¶ COMMIT CHECK"

  if git diff --cached --quiet; then
    fail "Brak zmian w staging. U≈ºyj rƒôcznie: ga"
  fi

  read -r -p "Commit message: " MSG
  [[ -z "$MSG" ]] && fail "Commit message pusta"

  git commit -m "$MSG" || fail "Commit failed"
  git push || fail "Push failed"
  ok "Commit + push OK"

  echo
  echo "üìì AKTYWNA.md"

  DATE="$(date '+%F %H:%M')"

  ENTRY="$(
    {
      echo
      echo "## üìÖ $DATE"
      echo
      echo "- Mode: commit"
      echo "- Risk: $RISK"
      echo "- Changes:"
      git diff --name-only HEAD
    }
  )"

  MARKER="# üìÖ SESJE (od najnowszej)"
  TMP="$(mktemp)"

  grep -q "^$MARKER$" "$SESSION_FILE" ||
    fail "Brak markera SESJE w AKTYWNA.md"

  awk -v entry="$ENTRY" -v marker="$MARKER" '
    $0 == marker {
      print
      print ""
      print entry
      next
    }
    { print }
  ' "$SESSION_FILE" >"$TMP"

  mv "$TMP" "$SESSION_FILE"

  ok "AKTYWNA.md updated"
fi
# ---------- FINAL SAFETY ----------
echo
read -r -p "Kontynuowaƒá? (wpisz 'zamykamy' aby przerwaƒá): " LAST
if [[ "$LAST" == "zamykamy" ]]; then
  fail "Przerwano has≈Çem awaryjnym"
fi

ok "NSS zako≈Ñczony pomy≈õlnie"
